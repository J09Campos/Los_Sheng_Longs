@page "{FuncionarioSeleccionado?}"
@model Reloj_Marcador.Pages.Horarios.IndexModel
@{
    ViewData["Title"] = "Gestión de Horarios";
}

<div class="container mt-4">
    <h2 class="mb-4">Gestión de Horarios del Funcionario: <strong>@Model.FuncionarioSeleccionado</strong></h2>

    <!-- Mensajes del sistema -->
    @if (TempData["CreateMessage0"] != null)
    {
        var tipo = TempData["CreateTitle0"]?.ToString() == "Operación Fallida." ? "danger" : "success";
        <div class="alert alert-@tipo alert-dismissible fade show" role="alert">
            <strong>@TempData["CreateTitle0"]</strong> @TempData["CreateMessage0"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    }

    <!-- Tabla de horarios -->
    <h4 class="mt-4">Horarios Asignados</h4>
    @if (!Model.Horarios.Any())
    {
        <div class="alert alert-info">No hay horarios registrados. Cree uno nuevo abajo.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Área</th>
                        <th>Descripción</th>
                        <th>Fecha Creación</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var horario in Model.Horarios)
                    {
                        <tr>
                            <td>@horario.ID_Horario</td>
                            <td>@(Model.AreasDisponibles.FirstOrDefault(a => a.ID_Area == horario.ID_Area)?.Nombre_Area ?? horario.ID_Area)</td>
                            <td>@horario.Descripcion</td>
                            <td>@horario.Fecha_Creacion.ToString("dd/MM/yyyy HH:mm")</td>
                            <td class="text-center">
                                <a href="@Url.Page("./Index", new { idHorario = horario.ID_Horario, FuncionarioSeleccionado = Model.FuncionarioSeleccionado })"
                                   class="btn btn-info btn-sm me-1">
                                    <i class="fas fa-eye"></i> Ver Detalles
                                </a>

                                <button type="button"
                                        class="btn btn-danger btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModal"
                                        data-id="@horario.ID_Horario"
                                        data-descripcion="@horario.Descripcion">
                                    <i class="fas fa-trash-alt"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <hr class="my-4" />

    <!-- Crear nuevo horario -->
    <h4>Agregar Nuevo Horario</h4>
    <form method="post" asp-page-handler="Create">
        <input type="hidden" name="FuncionarioSeleccionado" value="@Model.FuncionarioSeleccionado" />
        <input type="hidden" asp-for="NuevoHorario.ID_Funcionario" value="@Model.FuncionarioSeleccionado" />

        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <label asp-for="NuevoHorario.ID_Area" class="form-label">Área *</label>
                <select asp-for="NuevoHorario.ID_Area" class="form-select" required>
                    <option value="">Seleccione un área</option>
                    @foreach (var area in Model.AreasDisponibles)
                    {
                        <option value="@area.ID_Area">@area.Nombre_Area</option>
                    }
                </select>
            </div>
            <div class="col-md-6">
                <label asp-for="NuevoHorario.Descripcion" class="form-label">Descripción *</label>
                <input asp-for="NuevoHorario.Descripcion" type="text" class="form-control" required maxlength="255"
                       placeholder="Ej. Horario diurno semanal" />
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </form>

    <hr class="my-4" />

    <!-- Detalles del horario -->
    @if (Model.HorarioSeleccionado != null && Model.HorarioSeleccionado.ID_Horario > 0)
    {
        <h4 class="mb-3">
            Detalles del Horario: <strong>@Model.HorarioSeleccionado.Descripcion</strong>
        </h4>

        <form method="post" asp-page-handler="AgregarDetalle" asp-route-idHorario="@Model.HorarioSeleccionado.ID_Horario">
            <input type="hidden" name="FuncionarioSeleccionado" value="@Model.FuncionarioSeleccionado" />

            <div class="row g-3 mb-3">
                <div class="col-md-2">
                    <label class="form-label">Día *</label>
                    <select name="Dia" class="form-select" required>
                        <option value="">Seleccione día</option>
                        <option>Lunes</option>
                        <option>Martes</option>
                        <option>Miércoles</option>
                        <option>Jueves</option>
                        <option>Viernes</option>
                        <option>Sábado</option>
                        <option>Domingo</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Hora Ingreso *</label>
                    <input type="number" name="Hora_Ingreso" class="form-control" min="0" max="23" required />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Minuto Ingreso *</label>
                    <input type="number" name="Minuto_Ingreso" class="form-control" min="0" max="59" required />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Hora Salida *</label>
                    <input type="number" name="Hora_Salida" class="form-control" min="0" max="23" required />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Minuto Salida *</label>
                    <input type="number" name="Minuto_Salida" class="form-control" min="0" max="59" required />
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                </div>
            </div>
        </form>

        @if (Model.Detalles.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Día</th>
                            <th>Hora Ingreso</th>
                            <th>Hora Salida</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var detalle in Model.Detalles)
                        {
                            <tr>
                                <td>@detalle.Id_Detalle</td>
                                <td>@detalle.Dia</td>
                                <td>@($"{detalle.Hora_Ingreso:D2}:{detalle.Minuto_Ingreso:D2}")</td>
                                <td>@($"{detalle.Hora_Salida:D2}:{detalle.Minuto_Salida:D2}")</td>
                                <td class="text-center">
                                    <form method="post"
                                          asp-page-handler="EliminarDetalle"
                                          asp-route-id="@detalle.Id_Detalle"
                                          asp-route-idHorario="@Model.HorarioSeleccionado.ID_Horario"
                                          onsubmit="return confirm('¿Eliminar este detalle?');">
                                        <input type="hidden" name="FuncionarioSeleccionado" value="@Model.FuncionarioSeleccionado" />
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="fas fa-trash-alt"></i> Eliminar
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info">No hay detalles registrados. Agregue uno arriba.</div>
        }

        <div class="mt-3">
            <a href="@Url.Page("./Index", new { FuncionarioSeleccionado = Model.FuncionarioSeleccionado })"
               class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Lista
            </a>
        </div>
    }

    <!-- Modal eliminar horario -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    ¿Desea eliminar el horario <strong id="descripcionHorario"></strong>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form method="post" asp-page-handler="Delete" asp-route-id="">
                        <input type="hidden" name="FuncionarioSeleccionado" value="@Model.FuncionarioSeleccionado" />
                        <input type="hidden" id="idHorario" name="id" />
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Cargar datos del modal de eliminación
        const deleteModal = document.getElementById('deleteModal');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const descripcion = button.getAttribute('data-descripcion');
                deleteModal.querySelector('#idHorario').value = id;
                deleteModal.querySelector('#descripcionHorario').textContent = descripcion;
            });
        }
    </script>
    <partial name="_ValidationScriptsPartial" />
}
